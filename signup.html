<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário de Cadastro - Blog Casas de Repouso</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #4A5568; /* Cor de fundo principal (azul acinzentado escuro) */
        }
        .header-bg {
            background-color: #2D3748; /* Azul acinzentado um pouco mais escuro para o header */
        }
        .main-content-bg {
            background-color: #F7FAFC; /* Bege bem claro para o card de cadastro */
            min-height: calc(100vh - 80px - 64px); /* Altura da tela menos header e footer */
            display: flex;
            align-items: center;
            justify-content: center;
            padding-bottom: 10%; /* Espaço para a "onda" ou apenas para afastar do footer */
        }
        .footer-bg {
            background-color: #1A202C; /* Cor bem escura para o footer */
        }
        .btn-nav {
            transition: background-color 0.3s ease;
        }
        .btn-nav:hover {
            background-color: #4A5568; /* Um pouco mais claro ao passar o mouse */
        }
        .btn-nav.active { /* Mantém o estilo do botão Cadastre-se ativo */
            background-color: #3182CE;
            color: white;
        }
        .btn-nav.login {
             background-color: #718096; /* Cinza para o botão Entrar */
        }
        /* Simulação da onda no rodapé com gradiente, pode ser substituído por SVG */
        .wave-footer-bg {
            position: relative;
            background-color: #4A5568; /* Cor de fundo principal */
        }
        .wave-footer-bg::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100px; /* Altura da onda */
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1440 320'%3E%3Cpath fill='%23F7FAFC' fill-opacity='1' d='M0,192L80,176C160,160,320,128,480,133.3C640,139,800,181,960,186.7C1120,192,1280,160,1360,144L1440,128L1440,320L1360,320C1280,320,1120,320,960,320C800,320,640,320,480,320C320,320,160,320,80,320L0,320Z'%3E%3C/path%3E%3C/svg%3E") no-repeat bottom center;
            background-size: cover;
            z-index: 0;
        }
        .content-above-wave {
            position: relative;
            z-index: 1;
        }
        .form-input {
            background-color: #FFFFFF;
            border: 1px solid #E2E8F0; /* cinza claro */
        }
        .form-input:focus {
            border-color: #3182CE; /* azul */
            box-shadow: 0 0 0 1px #3182CE;
        }
        .hidden-field {
            display: none;
        }
        .message {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 0.375rem;
            font-weight: 500;
        }
        .message-success {
            background-color: #D1FAE5; /* green-100 */
            border: 1px solid #6EE7B7; /* green-400 */
            color: #065F46; /* green-700 */
        }
        .message-error {
            background-color: #FEE2E2; /* red-100 */
            border: 1px solid #FCA5A5; /* red-400 */
            color: #991B1B; /* red-700 */
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="header-bg shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div>
                <a href="index.html" class="text-white text-2xl font-bold">
                    <img src="https://placehold.co/100x40/FFFFFF/2D3748?text=LOGO" alt="Logo do Site" class="h-10 rounded">
                </a>
            </div>
            <div class="flex items-center space-x-3">
                <a href="index.html" class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-sm font-medium btn-nav">HOME</a>
                <a href="blog.html" class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-sm font-medium btn-nav">BLOG</a>
                <a href="sobre.html" class="text-gray-300 hover:text-white px-3 py-2 rounded-md text-sm font-medium btn-nav">SOBRE</a>
                <a href="login.html" class="text-white px-4 py-2 rounded-md text-sm font-semibold btn-nav login">ENTRAR</a>
                <a href="cadastro-selecao.html" class="text-white px-4 py-2 rounded-md text-sm font-semibold btn-nav active">CADASTRE-SE</a>
            </div>
        </nav>
    </header>

    <main class="flex-grow wave-footer-bg">
        <div class="main-content-bg content-above-wave pt-12 pb-12">
            <div class="bg-white p-8 md:p-12 rounded-xl shadow-2xl w-full max-w-lg text-center mx-4">
                <h1 class="text-xl text-gray-700 font-semibold mb-8 tracking-wide">
                    FAÇA PARTE E COMPARTILHE EXPERIÊNCIAS!
                </h1>
                <form id="registrationForm" class="space-y-6">
                    <div>
                        <input type="text" id="nome" name="nome" placeholder="Nome da casa de repouso" required
                               class="form-input w-full px-4 py-3 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div id="enderecoField">
                        <input type="text" id="endereco" name="endereco" placeholder="Endereço"
                               class="form-input w-full px-4 py-3 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div id="dataNascimentoField" class="hidden-field">
                        <input type="date" id="dataNascimento" name="dataNascimento" placeholder="Data de Nascimento"
                               class="form-input w-full px-4 py-3 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <input type="email" id="email" name="email" placeholder="E-mail" required
                               class="form-input w-full px-4 py-3 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <input type="password" id="senha" name="senha" placeholder="Senha" required
                               class="form-input w-full px-4 py-3 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <input type="hidden" id="tipoCadastro" name="tipoCadastro" value="casa_repouso">
                        <button type="submit"
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                            Cadastrar
                        </button>
                    </div>
                </form>
                <div id="messageContainer"></div>
            </div>
        </div>
    </main>

    <footer class="footer-bg text-white text-center py-5 z-10 relative">
        <p>&copy; EACH USP</p>
    </footer>

    <script type="module">
        // Ajuste o caminho para seus arquivos firebase.js e usuario.js conforme necessário
        import { registerUser } // Adicione outras funções se precisar, ex: insertFirebase
          from '../Utils/firebase.js'; // Assumindo que firebase.js está na mesma pasta ou ajuste o caminho
        import { Usuario }
          from '../Classes/usuario.js'; // Assumindo que usuario.js está na mesma pasta ou ajuste o caminho

        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const tipo = urlParams.get('tipo') || 'casa_repouso'; // Define um default se não houver parâmetro

            const nomeInput = document.getElementById('nome');
            const tipoCadastroInput = document.getElementById('tipoCadastro');
            const enderecoField = document.getElementById('enderecoField');
            const enderecoInput = document.getElementById('endereco');
            const dataNascimentoField = document.getElementById('dataNascimentoField');
            const dataNascimentoInput = document.getElementById('dataNascimento');
            const messageContainer = document.getElementById('messageContainer');

            function updateFormFields(currentType) {
                if (currentType === 'usuario_comum') {
                    if(nomeInput) nomeInput.placeholder = 'Nome';
                    if(tipoCadastroInput) tipoCadastroInput.value = 'usuario_comum';
                    if(enderecoField) enderecoField.classList.add('hidden-field');
                    if(enderecoInput) enderecoInput.required = false;
                    if(dataNascimentoField) dataNascimentoField.classList.remove('hidden-field');
                    if(dataNascimentoInput) dataNascimentoInput.required = true;
                } else { // Default ou 'casa_repouso'
                    if(nomeInput) nomeInput.placeholder = 'Nome da casa de repouso';
                    if(tipoCadastroInput) tipoCadastroInput.value = 'casa_repouso';
                    if(enderecoField) enderecoField.classList.remove('hidden-field');
                    if(enderecoInput) enderecoInput.required = true;
                    if(dataNascimentoField) dataNascimentoField.classList.add('hidden-field');
                    if(dataNascimentoInput) dataNascimentoInput.required = false;
                }
            }

            updateFormFields(tipo); // Configura o formulário na carga inicial

            const registrationForm = document.getElementById('registrationForm');
            if (registrationForm) {
                registrationForm.addEventListener('submit', async function(event) {
                    event.preventDefault();
                    messageContainer.innerHTML = ''; // Limpa mensagens anteriores

                    const formData = new FormData(registrationForm);
                    const data = Object.fromEntries(formData.entries());

                    const email = data.email;
                    const password = data.senha;
                    const nome = data.nome;
                    const tipoConta = data.tipoCadastro; // Valor de tipoCadastroInput

                    try {
                        // 1. Registrar usuário na autenticação do Firebase
                        const userCredential = await registerUser(email, password); //
                        const firebaseUser = userCredential.user;
                        console.log('Usuário registrado na autenticação:', firebaseUser.uid);

                        // 2. Preparar e salvar dados do perfil no Realtime Database
                        const novoUsuario = new Usuario(); //
                        novoUsuario.ID_usuario = firebaseUser.uid; //
                        novoUsuario.Nome = nome; //
                        novoUsuario.Email = email; //
                        novoUsuario.Casa_repouso = tipoConta === 'casa_repouso'; //

                        if (tipoConta === 'casa_repouso') {
                            novoUsuario.Endereco = data.endereco || null; //
                            novoUsuario.Nascimento = null; //
                        } else { // usuario_comum
                            novoUsuario.Nascimento = data.dataNascimento || null; //
                            novoUsuario.Endereco = null; //
                        }
                        // novoUsuario.Icone = null; // Defina se tiver um campo para ícone

                        await novoUsuario.saveProfileData(); //
                        console.log('Dados do perfil salvos no Realtime Database.');

                        messageContainer.innerHTML = `<div class="message message-success">Cadastro realizado com sucesso! Redirecionando para o login...</div>`;
                        registrationForm.reset();
                        updateFormFields(tipo); // Reseta os campos para o tipo atual

                        // Opcional: Redirecionar para a página de login ou dashboard após sucesso
                        setTimeout(() => {
                             window.location.href = 'login.html'; // Ajuste para sua página de login
                        }, 3000);

                    } catch (error) {
                        console.error('Erro no cadastro:', error);
                        let errorMessage = 'Erro ao realizar o cadastro. Tente novamente.';
                        if (error.code) {
                            switch (error.code) {
                                case 'auth/email-already-in-use':
                                    errorMessage = 'Este e-mail já está em uso.';
                                    break;
                                case 'auth/invalid-email':
                                    errorMessage = 'Formato de e-mail inválido.';
                                    break;
                                case 'auth/weak-password':
                                    errorMessage = 'A senha é muito fraca. Use pelo menos 6 caracteres.';
                                    break;
                                default:
                                    errorMessage = `Erro: ${error.message}`;
                            }
                        } else if (error.message.includes("ID do usuário é obrigatório")) {
                            errorMessage = "Ocorreu um erro ao preparar os dados do perfil. Tente novamente.";
                        }
                        messageContainer.innerHTML = `<div class="message message-error">${errorMessage}</div>`;
                    }
                });
            }
        });
    </script>

</body>
</html>